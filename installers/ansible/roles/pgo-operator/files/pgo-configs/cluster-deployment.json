{
    "kind": "Deployment",
    "apiVersion": "apps/v1",
    "metadata": {
        "name": "{{.Name}}",
        "labels": {
            "vendor": "crunchydata",
            "pgo-pg-database": "true",
            {{.DeploymentLabels }}
        }
    },
    "spec": {
        "replicas": {{.Replicas}},
        "selector": {
          "matchLabels": {
            "vendor": "crunchydata",
            "pg-cluster": "{{.ClusterName}}",
            "pgo-pg-database": "true",
            "deployment-name": "{{.Name}}"
          }
        },
        "template": {
            "metadata": {
                {{ if .PodAnnotations }}
                "annotations": {{ .PodAnnotations }},
                {{ end }}
                "labels": {
                    "name": "{{.Name}}",
                    "vendor": "crunchydata",
                    "pgo-pg-database": "true",
                    "{{.PodAntiAffinityLabelName}}": "{{.PodAntiAffinityLabelValue}}",
                    {{.PodLabels }}
                }
            },
            "spec": {
                "securityContext": {{.SecurityContext}},
                "serviceAccountName": "pgo-pg",
                {{ if .Tolerations }}
                "tolerations": {{ .Tolerations }},
                {{ end }}
                "containers": [
            {
                    "name": "database",
                    "image": "{{.Image}}",
                    "readinessProbe": {
                        "exec": {
                            "command": [
                                "/opt/crunchy/bin/postgres-ha/health/pgha-readiness.sh"
                            ]
                        },
                        "initialDelaySeconds": 15
                    },
                    "livenessProbe": {
                        "exec": {
                            "command": [
                                "/opt/crunchy/bin/postgres-ha/health/pgha-liveness.sh"
                            ]
                        },
                        "initialDelaySeconds": 30,
                        "periodSeconds": 15,
                        "timeoutSeconds": 10
                    },
                    {{.ContainerResources }}
                    "env": [{
                        "name": "MODE",
                        "value": "postgres"
                    },
                    {
                        "name": "PGHA_PG_PORT",
                        "value": "{{.Port}}"
                    }, {
                        "name": "PGHA_USER",
                        "value": "postgres"
                    },
                    {{if .IsInit}}
                    {
                        "name": "PGHA_INIT",
                        "valueFrom": {
                            "configMapKeyRef": {
                               "name": "{{.ClusterName}}-pgha-config",
                               "key": "init"
                            }
                         }
                    },
                    {{ end }}
                    {{if .Tablespaces}}
                    {
                        "name": "PGHA_TABLESPACES",
                        "value": "{{ .Tablespaces }}"
                    },
                    {{ end }}
                    {
                        "name": "PATRONI_POSTGRESQL_DATA_DIR",
                        "value": "/pgdata/{{.Name}}"
                    },
                    {{.PgbackrestS3EnvVars}}
                    {{.PgbackrestEnvVars}}
                    {{.PgmonitorEnvVars}}
                    {
                        "name": "PGHA_DATABASE",
                        "value": "{{.Database}}"
                    }, {
                        "name": "PGHA_REPLICA_REINIT_ON_START_FAIL",
                        "value": "{{.ReplicaReinitOnStartFail}}"
                    }, {
                        "name": "PGHA_SYNC_REPLICATION",
                        "value": "{{.SyncReplication}}"
                    }, {
                        "name": "PGHA_TLS_ENABLED",
                        "value": "{{.TLSEnabled}}"
                    }, {
                        "name": "PGHA_TLS_ONLY",
                        "value": "{{.TLSOnly}}"
                    }, {
                        "name": "PGHA_STANDBY",
                        "value": "{{.Standby}}"
                    }, {
                        "name": "PATRONI_KUBERNETES_NAMESPACE",
                        "valueFrom": {
                            "fieldRef": {
                                "fieldPath": "metadata.namespace"
                            }
                        }
                    },  {
                        "name": "PATRONI_KUBERNETES_SCOPE_LABEL",
                        "value": "{{.ScopeLabel}}"
                    },  {
                        "name": "PATRONI_SCOPE",
                        "valueFrom": {
                            "fieldRef": {
                                "fieldPath": "metadata.labels['{{.ScopeLabel}}']"
                            }
                        }
                    }, {
                        "name": "PATRONI_KUBERNETES_LABELS",
                        "value": "{vendor: \"crunchydata\"}"
                    }, {
                        "name": "PATRONI_LOG_LEVEL",
                        "value": "INFO"
                    }, {
                        "name": "PGHOST",
                        "value": "/tmp"
                    }],


                    "volumeMounts": [{
                            "mountPath": "/pgdata",
                            "name": "pgdata",
                            "readOnly": false
                        }, {
                            "mountPath": "/pgconf/pguser",
                            "name": "user-volume"
                        }, {
                            "mountPath": "/pgconf/pgreplicator",
                            "name": "primary-volume"
                        }, {
                            "mountPath": "/pgconf/pgsuper",
                            "name": "root-volume"
                        },
                        {{if .TLSEnabled}}
                        {
                          "mountPath": "/pgconf/tls",
                          "name": "tls-server"
                        },
                          {{if .ReplicationTLSSecret}}
                          {
                            "mountPath": "/pgconf/tls-replication",
                            "name": "tls-replication"
                          },
                          {{ end }}
                        {{ end }}
                        {
                            "mountPath": "/sshd",
                            "name": "sshd",
                            "readOnly": true
                        }, {
                            "mountPath": "/pgconf",
                            "name": "pgconf-volume"
                        },
                        {
                            "mountPath": "/dev/shm",
                            "name": "dshm"
                        },
                        {
                            "mountPath": "/etc/pgbackrest/conf.d",
                            "name": "pgbackrest-config"
                        },
                        {
                            "mountPath": "/etc/podinfo",
                            "name": "podinfo"
                        }
                        {{.TablespaceVolumeMounts}}
                    ],

                    "ports": [{
                        "containerPort": 5432,
                        "protocol": "TCP"
                    }, 
                    {
                        "containerPort": 8009,
                        "protocol": "TCP"
                    }],
                    "imagePullPolicy": "IfNotPresent"
                }
                {{ if .PMMEnabled }}
                ,{
                    "name": "pmm-client",
                    "image": "{{.PMMImage}}",
                    "ports": [{
                          "containerPort": 7777,
                          "protocol": "TCP"
                      },
                      {
                          "containerPort": 30100
                      }, 
                      {
                          "containerPort": 30101
                      }, 
                      {
                          "containerPort": 30102
                      }, 
                      {
                          "containerPort": 30103
                      }, 
                      {
                          "containerPort": 30104
                      }, 
                      {
                          "containerPort": 30105
                      }],
                    "env": [{
                      "name": "PMM_USER",
                      "value": "{{.PMMServerUser}}"
                    },
                    {
                      "name": "PMM_SERVER",
                      "value": "{{.PMMServerHost}}"
                    },
                    {
                      "name":  "CLIENT_PORT_LISTEN",
                      "value": "7777"
                    },
                    {
                      "name":  "CLIENT_PORT_MIN",
                      "value": "30100"
                    },
                    {
                      "name":  "CLIENT_PORT_MAX",
                      "value": "30105"
                    },
                    {
                      "name": "POD_NAME",
                      "valueFrom": {
                        "fieldRef": {
                            "apiVersion": "v1",
                            "fieldPath": "metadata.name"
                        }
                      }
                    },
                    {
                        "name": "POD_NAMESPASE",
                        "valueFrom": {
                            "fieldRef": {
                                "apiVersion": "v1",
                                "fieldPath": "metadata.namespace"
                            }
                        }
                    },
                    {
                      "name":  "PMM_AGENT_SERVER_ADDRESS",
                      "value": "{{.PMMServerHost}}"
                    },
                    {
                      "name":  "PMM_AGENT_SERVER_USERNAME",
                      "value": "{{.PMMServerUser}}"
                    },
                    {
                      "name": "PMM_AGENT_SERVER_PASSWORD",
                      "valueFrom": {
                        "secretKeyRef": {
                            "name": "{{.PMMSecret}}",
                            "key": "password"
                        }
                      }
                    },
                    {
                      "name":  "PMM_AGENT_LISTEN_PORT",
                      "value": "7777"
                    },
                    {
                      "name":  "PMM_AGENT_PORTS_MIN",
                      "value": "30100"
                    },
                    {
                      "name":  "PMM_AGENT_PORTS_MAX",
                      "value": "30105"
                    },
                    {
                      "name":  "PMM_AGENT_CONFIG_FILE",
                      "value": "/usr/local/percona/pmm2/config/pmm-agent.yaml"
                    },
                    {
                      "name":  "PMM_AGENT_SERVER_INSECURE_TLS",
                      "value": "1"
                    },
                    {
                      "name":  "PMM_AGENT_LISTEN_ADDRESS",
                      "value": "0.0.0.0"
                    },
                    {
                      "name": "PMM_AGENT_SETUP_NODE_NAME",
                      "value": "$(POD_NAMESPASE)-$(POD_NAME)"
                    },
                    {
                      "name":  "PMM_AGENT_SETUP_METRICS_MODE",
                      "value": "push"
                    },
                    {
                      "name":  "PMM_AGENT_SETUP",
                      "value": "1"
                    },
                    {
                      "name":  "PMM_AGENT_SETUP_FORCE",
                      "value": "1"
                    },
                    {
                      "name":  "PMM_AGENT_SETUP_NODE_TYPE",
                      "value": "container"
                    },
                    {
                      "name":  "DB_TYPE",
                      "value": "postgresql"
                    },
                    {
                      "name":  "DB_PASS",
                      "valueFrom": {
                        "secretKeyRef": {
                            "name": "{{.RootSecretName}}",
                            "key": "password"
                        }
                      }
                    },
                    {
                      "name":  "PMM_AGENT_PRERUN_SCRIPT",
                      "value": "pmm-admin status --wait=10s; pmm-admin add postgresql --skip-connection-check --metrics-mode=push --username=postgres --password=$(DB_PASS) --service-name=$(PMM_AGENT_SETUP_NODE_NAME) --host=$(POD_NAME) --port=5432 --query-source=none; pmm-admin annotate --service-name=$(PMM_AGENT_SETUP_NODE_NAME) 'Service restarted'"
                    }]
                }
                {{ end }}
                {{ if .ExporterAddon }}
                ,{{.ExporterAddon }}
                {{ end }}
                {{ if .BadgerAddon }}
                ,{{.BadgerAddon }}
                {{ end }}
                ],
                "volumes": [{
                        "name": "pgdata",
                        {{.PVCName}}
                    }, {
                        "name": "user-volume",
                        "secret": {
                            "secretName": "{{.UserSecretName}}"
                        }
                    }, {
                        "name": "primary-volume",
                        "secret": {
                            "secretName": "{{.PrimarySecretName}}"
                        }
                    }, {
                        "name": "sshd",
                        "secret": {
                            "secretName": "{{.ClusterName}}-backrest-repo-config"
                        }
                    }, {
                        "name": "root-volume",
                        "secret": {
                            "secretName": "{{.RootSecretName}}"
                        }
                    },
                    {{if .TLSEnabled}}
                    {
                      "name": "tls-server",
                      "projected": {
                        "defaultMode": 288,
                        "sources": [
                          {
                            "secret": {
                                "name": "{{.TLSSecret}}"
                            }
                          },
                          {{if .ReplicationTLSSecret}}
                          {
                            "secret": {
                                "name": "{{.ReplicationTLSSecret}}",
                                "items": [
                                  {
                                    "key": "tls.key",
                                    "path": "tls-replication.key"
                                  },
                                  {
                                    "key": "tls.crt",
                                    "path": "tls-replication.crt"
                                  }
                                ]
                            }
                          },
                          {{ end }}
                          {
                            "secret": {
                                "name": "{{.CASecret}}"
                            }
                          }
                        ]
                      }
                    },
                      {{if .ReplicationTLSSecret}}
                      {
                        "name": "tls-replication",
                        "emptyDir": {
                          "medium": "Memory",
                          "sizeLimit": "2Mi"
                        }
                      },
                      {{ end }}
                    {{ end }}
                    {
                        "name": "report",
                        "emptyDir": {
                          "medium": "Memory",
                          "sizeLimit": "64Mi"
                        }
                    },
                    {
                      "name": "dshm",
                      "emptyDir": {
                        "medium": "Memory"
                      }
                    },
                    {
                      "name": "pgbackrest-config",
                      "projected": { "sources": [] }
                    },
                    {
                        "name": "pgconf-volume",
                        "projected": {
                            "sources": [
                                {{if .ConfVolume}}
                                {
                                    "configMap": {
                                        "name": {{.ConfVolume}}
                                    }
                                },
                                {{end}}
                                {
                                    "configMap": {
                                        "name": "{{.ClusterName}}-pgha-config",
                                        "optional": true
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "name": "podinfo",
                        "downwardAPI": {
                            "defaultMode": 420,
                            "items": [
                                {
                                    "path": "cpu_limit",
                                    "resourceFieldRef": {
                                        "containerName": "database",
                                        "divisor": "1m",
                                        "resource": "limits.cpu"
                                    }
                                },
                                {
                                    "path": "cpu_request",
                                    "resourceFieldRef": {
                                        "containerName": "database",
                                        "divisor": "1m",
                                        "resource": "requests.cpu"
                                    }
                                },
                                {
                                    "path": "mem_limit",
                                    "resourceFieldRef": {
                                        "containerName": "database",
                                        "resource": "limits.memory"
                                    }
                                },
                                {
                                    "path": "mem_request",
                                    "resourceFieldRef": {
                                        "containerName": "database",
                                        "resource": "requests.memory"
                                    }
                                },
                                {
                                    "fieldRef": {
                                        "apiVersion": "v1",
                                        "fieldPath": "metadata.labels"
                                    },
                                    "path": "labels"
                                },
                                {
                                    "fieldRef": {
                                        "apiVersion": "v1",
                                        "fieldPath": "metadata.annotations"
                                    },
                                    "path": "annotations"
                                }
                            ]
                        }
                    }
                    {{.TablespaceVolumes}}
                ],
                "affinity": {
                  {{if .NodeSelector}}
                  "nodeAffinity": {{ .NodeSelector }}
                  {{ end }}
                  {{if and .NodeSelector .PodAntiAffinity}},{{end}}
                  {{.PodAntiAffinity}}
                },
                "restartPolicy": "Always",
                "dnsPolicy": "ClusterFirst"
            }
        },
        "strategy": {
            "type": "RollingUpdate",
            "rollingUpdate": {
                "maxUnavailable": 1,
                "maxSurge": 1
            }
        }
    }
}
