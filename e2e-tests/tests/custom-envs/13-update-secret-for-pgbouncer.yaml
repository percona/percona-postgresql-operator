apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 30
commands:
  - script: |-
      set -o errexit
      set -o xtrace
      
      source ../../functions
      
      kubectl create secret generic pgbouncer-env-secret-updated \
        --from-literal=DB_USER_NEW=myuser2 \
        --from-literal=DB_PASSWORD_NEW=NewS3cretP@ss \
        --dry-run=client -o yaml | kubectl -n "${NAMESPACE}" apply -f -
      
      kubectl get pg custom-envs -n "${NAMESPACE}" -o yaml | \
        yq eval '.spec.proxy.pgBouncer.envFrom = [{"secretRef": {"name": "pgbouncer-env-secret-updated"}}]' - | \
        kubectl apply -f -
      
      sleep 10  
      wait_cluster_consistency custom-envs
        
      check_env_in_pod add pgbouncer DB_USER_NEW myuser2

