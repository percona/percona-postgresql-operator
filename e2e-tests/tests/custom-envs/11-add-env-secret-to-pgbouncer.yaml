apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 20
commands:
  - script: |-
      set -o errexit
      set -o xtrace
      
      source ../../functions
      
      kubectl create secret generic pgbouncer-env-secret \
        --from-literal=DB_USER=myuser \
        --from-literal=DB_PASSWORD='MyS3cretP@ss' \
        -n "${NAMESPACE}"
      
      kubectl get pg custom-envs -n "${NAMESPACE}" -o yaml | \
        yq eval '
          .spec.proxy.pgBouncer.envFrom += [{"secretRef": {"name": "pgbouncer-env-secret"}}]
        ' - | kubectl apply -f -

      sleep 10  
      wait_cluster_consistency custom-envs
      check_envs_for_component add pgbouncer DB_USER=myuser DB_PASSWORD=MyS3cretP@ss
