apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 10
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions
      get_cr | yq eval '
        .spec.proxy.pgBouncer.replicas = 1 |
        .spec.instances[].replicas = 1 |
        .spec.instances[].env = ((.spec.instances[].env // []) + [{"name": "FIRST_ENV", "value": "1000"}, {"name": "SECOND_ENV", "value": "2000"}] | unique_by(.name))
        ' - | kubectl -n "${NAMESPACE}" apply -f -

  
        sleep 10  
        wait_cluster_consistency custom-envs
        
        check_envs_for_component add instance FIRST_ENV=1000 SECOND_ENV=2000
        
