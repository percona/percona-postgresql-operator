apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 20
commands:
  - script: |-
      set -o errexit
      set -o xtrace
      
      source ../../functions
      
      kubectl create secret generic repo-host-env-secret \
        --from-literal=DB_USER_TEST_ENV=myuser \
        --from-literal=DB_PASSWORD_TEST_ENV='MyS3cretP@ss' \
        -n "${NAMESPACE}" || true
      
      kubectl get pg custom-envs -n ${NAMESPACE} -o yaml | \
        yq eval '.spec.backups.pgbackrest.envFrom += [{"secretRef": {"name": "repo-host-env-secret"}}]' - | \
        kubectl apply -f -

      sleep 60  
      wait_cluster_consistency custom-envs
        
      check_env_in_pod add repohost DB_USER_TEST_ENV myuser
