apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 30
commands:
    - script: |-
          set -o errexit
          set -o xtrace
          
          source ../../functions
          
          # Create new secret with new env vars
          kubectl create secret generic instance-env-secret-updated \
            --from-literal=DB_USER_NEW=myuser2 \
            --from-literal=DB_PASSWORD_NEW='NewS3cretP@ss' \
            -n "${NAMESPACE}"
          
          # Patch the CR to reference the new secret
          kubectl get pg custom-envs -n ${NAMESPACE} -o yaml | \
            yq eval '.spec.instances[].envFrom = [{"secretRef": {"name": "instance-env-secret-updated"}}]' - | \
            kubectl apply -f -
  
          sleep 10  
          wait_cluster_consistency custom-envs
          check_envs_for_component add instance DB_USER_NEW=myuser2 DB_PASSWORD_NEW=NewS3cretP@ss

