apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 30
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      sleep 30 # wait for the operator to apply it via pod exec

      uri="postgres:$(get_psql_user_pass cluster1-pguser-postgres)@$(get_psql_user_host cluster1-pguser-postgres)"
      uri_replicas="postgres:$(get_psql_user_pass cluster1-pguser-postgres)@cluster1-replicas"
      
      wal_level=$(run_psql_local 'SHOW wal_level;' "$uri" | xargs)
      restore_command=$(run_psql_local 'SHOW restore_command;' "$uri_replicas" | xargs)

      kubectl create configmap -n "${NAMESPACE}" 03-pg-settings \
        --from-literal=wal_level="${wal_level}" \
        --from-literal=restore_command="${restore_command}"
