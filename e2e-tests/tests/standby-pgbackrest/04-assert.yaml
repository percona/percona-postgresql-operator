apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 600
commands:
  - script: |-
      set -o errexit

      kubectl wait --for=jsonpath='{.status.state}'=initializing --timeout=420s -n "${NAMESPACE}" pg/standby-cluster

      lagBytes=$(kubectl get pg -n "${NAMESPACE}" standby-cluster -o jsonpath='{.status.standby.lagBytes}')
      condStatus=$(kubectl get pg -n "${NAMESPACE}" standby-cluster -o jsonpath='{.status.conditions[?(@.type=="StandbyLagging")].status}')
      condReason=$(kubectl get pg -n "${NAMESPACE}" standby-cluster -o jsonpath='{.status.conditions[?(@.type=="StandbyLagging")].reason}')
      condMsg=$(kubectl get pg -n "${NAMESPACE}" standby-cluster -o jsonpath='{.status.conditions[?(@.type=="StandbyLagging")].message}')
      test "$condStatus" = "True"
      test "$condReason" = "LagDetected"
      test "$condMsg" = "WAL is lagging by $lagBytes bytes (threshold: 1024 bytes)"
