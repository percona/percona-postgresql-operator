apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      instance=$(kubectl get -n "${NAMESPACE}" pod -l postgres-operator.crunchydata.com/instance-set=instance1 -o 'jsonpath={.items[].metadata.name}')

      backup_name="demand-backup-full"
      job_name=$(kubectl get -n "${NAMESPACE}" pg-backup $backup_name -o jsonpath='{.status.jobName}')

      job_annotation=$(kubectl exec -n "${NAMESPACE}" $instance -c database -- pgbackrest info --output json \
        | jq ".[0].backup.[] | select(.annotation.\"percona.com/backup-name\" == \"$backup_name\") | .annotation.\"percona.com/backup-job-name\"" --raw-output)

      if [[ "$job_name" != "$job_annotation" ]]; then
        echo "Failed to get job name annotation from pgbackrest"
        exit 1
      fi


