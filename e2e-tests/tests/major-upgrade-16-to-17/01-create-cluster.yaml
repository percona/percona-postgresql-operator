apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 10
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      get_cr \
        | yq eval '
          .spec.postgresVersion = 16 |
          .spec.image = "perconalab/percona-postgresql-operator:main-ppg16-postgres" |
          .spec.instances[0].dataVolumeClaimSpec.resources.requests.storage = "3Gi" |
          .spec.proxy.pgBouncer.image = "perconalab/percona-postgresql-operator:main-pgbouncer16" |
          .spec.backups.pgbackrest.image = "perconalab/percona-postgresql-operator:main-pgbackrest16" |
          .spec.patroni.dynamicConfiguration.postgresql.parameters.shared_preload_libraries = "pg_cron" |
          .spec.extensions.custom += [{"name": "pg_cron", "version": "1.6.6"}]' \
        | yq eval '
          .spec.extensions.image = "'"${IMAGE}"'" |
          .spec.extensions.imagePullPolicy = "Always" |
          .spec.extensions.storage = {"type": "s3", "bucket": "pg-extensions", "region": "eu-central-1", "secret": {"name": "aws-s3-secret"}}' \
        | kubectl -n "${NAMESPACE}" apply -f -
