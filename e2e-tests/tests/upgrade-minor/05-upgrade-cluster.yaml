apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 15
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      pg_ver_lower="$(cat ${TEMP_DIR}/pg_ver.txt)"
      pg_ver_upper=$(echo "$IMAGE_POSTGRESQL" | cut -d':' -f2 | grep -oE '\-ppg[0-9]+-' | grep -oE '[0-9]+' | tr -d '-')
      TARGET_IMAGE_POSTGRESQL=$IMAGE_POSTGRESQL
      TARGET_IMAGE_PGBOUNCER=$IMAGE_PGBOUNCER
      TARGET_IMAGE_BACKREST=$IMAGE_BACKREST

      if [ "${pg_ver_lower}" != "${pg_ver_upper}" ]; then
          TARGET_IMAGE_POSTGRESQL="perconalab/percona-postgresql-operator:main-ppg${pg_ver_lower}-postgres"
          TARGET_IMAGE_PGBOUNCER="perconalab/percona-postgresql-operator:main-ppg${pg_ver_lower}-pgbouncer"
          TARGET_IMAGE_BACKREST="perconalab/percona-postgresql-operator:main-ppg${pg_ver_lower}-pgbackrest"
      fi

      yq -i eval '
          .metadata.name = "'${test_name}'" |
          .metadata.labels = {"e2e":"'${test_name}'"} |
          .spec.image = "'${TARGET_IMAGE_POSTGRESQL}'" |
          .spec.proxy.pgBouncer.image = "'${TARGET_IMAGE_PGBOUNCER}'" |
          .spec.backups.pgbackrest.image = "'${TARGET_IMAGE_BACKREST}'"' "${TEMP_DIR}/cr_lower.yaml"
      kubectl -n "${NAMESPACE}" apply -f "${TEMP_DIR}/cr_lower.yaml"
      sleep 7 # wait for reconcile loop

      kubectl wait -n $NAMESPACE --timeout 180s --for=jsonpath='{.spec.template.spec.containers[0].image}'=$TARGET_IMAGE_BACKREST sts/upgrade-minor-repo-host
      kubectl wait -n $NAMESPACE --timeout 180s --for=jsonpath='{.spec.template.spec.containers[0].image}'=$TARGET_IMAGE_PGBOUNCER deployment/upgrade-minor-pgbouncer
      for s in $(kubectl get sts --no-headers -l postgres-operator.crunchydata.com/instance-set=instance1 --output=custom-columns='NAME:.metadata.name'); do
          kubectl wait -n $NAMESPACE --timeout 180s --for=jsonpath='{.spec.template.spec.containers[0].image}'=$TARGET_IMAGE_POSTGRESQL sts/${s}
      done
