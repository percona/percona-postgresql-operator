apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 120
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      verify_secret_data() {
          local secret_name="$1"
          shift
          for key in "$@"; do
              val=$(kubectl -n "$NAMESPACE" get secret "$secret_name" -o jsonpath="{.data['${key}']}")
              if [[ -z "$val" ]]; then
                  echo "Secret $secret_name is missing key: $key"
                  return 1
              fi
          done
      }

      retry 12 5 verify_secret_data cert-manager-tls-cluster-ca-cert tls.crt tls.key ca.crt

      ca_secret_type=$(kubectl -n "$NAMESPACE" get secret cert-manager-tls-cluster-ca-cert -o jsonpath='{.type}')
      if [[ "$ca_secret_type" != "kubernetes.io/tls" ]]; then
          echo "CA secret type is incorrect: $ca_secret_type (expected kubernetes.io/tls)"
          exit 1
      fi

      ca_issuer_name=$(kubectl -n "$NAMESPACE" get secret cert-manager-tls-cluster-ca-cert -o jsonpath='{.metadata.annotations.cert-manager\.io/issuer-name}')
      if [[ "$ca_issuer_name" != "cert-manager-tls-ca-issuer" ]]; then
          echo "CA secret issuer annotation is incorrect: $ca_issuer_name"
          exit 1
      fi

      retry 12 5 verify_secret_data cert-manager-tls-cluster-cert tls.crt tls.key ca.crt

      cluster_secret_type=$(kubectl -n "$NAMESPACE" get secret cert-manager-tls-cluster-cert -o jsonpath='{.type}')
      if [[ "$cluster_secret_type" != "kubernetes.io/tls" ]]; then
          echo "Cluster TLS secret type is incorrect: $cluster_secret_type (expected kubernetes.io/tls)"
          exit 1
      fi

      cluster_issuer_name=$(kubectl -n "$NAMESPACE" get secret cert-manager-tls-cluster-cert -o jsonpath='{.metadata.annotations.cert-manager\.io/issuer-name}')
      if [[ "$cluster_issuer_name" != "cert-manager-tls-tls-issuer" ]]; then
          echo "Cluster TLS secret issuer annotation is incorrect: $cluster_issuer_name"
          exit 1
      fi

      retry 12 5 verify_secret_data cert-manager-tls-pgbouncer-frontend-tls tls.crt tls.key ca.crt

      pgb_secret_type=$(kubectl -n "$NAMESPACE" get secret cert-manager-tls-pgbouncer-frontend-tls -o jsonpath='{.type}')
      if [[ "$pgb_secret_type" != "kubernetes.io/tls" ]]; then
          echo "PgBouncer TLS secret type is incorrect: $pgb_secret_type (expected kubernetes.io/tls)"
          exit 1
      fi

      pgb_issuer_name=$(kubectl -n "$NAMESPACE" get secret cert-manager-tls-pgbouncer-frontend-tls -o jsonpath='{.metadata.annotations.cert-manager\.io/issuer-name}')
      if [[ "$pgb_issuer_name" != "cert-manager-tls-tls-issuer" ]]; then
          echo "PgBouncer TLS secret issuer annotation is incorrect: $pgb_issuer_name"
          exit 1
      fi

      instance_sts=$(kubectl -n "$NAMESPACE" get sts -l postgres-operator.crunchydata.com/cluster=cert-manager-tls,postgres-operator.crunchydata.com/instance-set=instance1 -o jsonpath='{.items[*].metadata.name}')
      for sts_name in $instance_sts; do
          secret_name="${sts_name}-certs"

          secret_type=$(kubectl -n "$NAMESPACE" get secret "$secret_name" -o jsonpath='{.type}')
          if [[ "$secret_type" != "Opaque" ]]; then
              echo "Instance secret $secret_name type is incorrect: $secret_type (expected Opaque)"
              exit 1
          fi

          issuer_name=$(kubectl -n "$NAMESPACE" get secret "$secret_name" -o jsonpath='{.metadata.annotations.cert-manager\.io/issuer-name}')
          if [[ "$issuer_name" != "cert-manager-tls-tls-issuer" ]]; then
              echo "Instance secret $secret_name issuer annotation is incorrect: $issuer_name"
              exit 1
          fi

          verify_secret_data "$secret_name" tls.crt tls.key dns.crt dns.key
          echo "Instance secret $secret_name is valid"
      done
