apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 20
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions
      platform=$(detect_k8s_platform)
      enable_hugepages $platform
      get_cr \
        | yq '.spec.instances[0].resources.limits.hugepages-2Mi = "2Gi"' \
        | yq '.spec.proxy.pgBouncer.replicas=1' \
        | yq '.spec.instances[].replicas=1' \
        | yq '.spec.instances[0].resources.limits.memory = "4Gi"' \
        | yq '.spec.patroni.dynamicConfiguration.postgresql.parameters.shared_buffers = "1GB"' \
        | kubectl -n "${NAMESPACE}" apply -f -