apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      primary=$(get_pod_by_role major-upgrade-17-to-18 primary name)
      latest_full_repo2_backup=$(kubectl -n ${NAMESPACE} exec ${primary} -- pgbackrest info --output json --log-level-console=info | jq -r '[.[] | .backup[] | select(.type == "full") | select(.database["repo-key"] == 2)][-1].label')

      cat <<EOF | kubectl -n ${NAMESPACE} apply -f -
      apiVersion: pgv2.percona.com/v2
      kind: PerconaPGRestore
      metadata:
        name: restore-after-17-to-18
      spec:
        pgCluster: major-upgrade-17-to-18
        repoName: repo2
        options:
        - --set=${latest_full_repo2_backup}
        - --type=immediate
      EOF
