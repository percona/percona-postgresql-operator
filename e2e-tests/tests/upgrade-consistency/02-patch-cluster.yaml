apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 30
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      cr_version="2.8.0"

      backrest_image=$(get_version_images $cr_version BACKREST${PG_VER} )
      pgbouncer_image=$(get_version_images $cr_version PGBOUNCER${PG_VER})
      postgres_image=$(get_version_images $cr_version POSTGRESQL${PG_VER})

      get_cr \
        | yq eval ".spec.crVersion=\"$cr_version\"" - \
        | yq eval ".spec.image=\"${REGISTRY_NAME_FULL}${postgres_image}\"" - \
        | yq eval ".spec.backups.pgbackrest.image=\"${REGISTRY_NAME_FULL}${backrest_image}\"" - \
        | yq eval ".spec.proxy.pgBouncer.image=\"${REGISTRY_NAME_FULL}${pgbouncer_image}\"" - \
        | kubectl -n "${NAMESPACE}" apply -f -

      sleep 10
